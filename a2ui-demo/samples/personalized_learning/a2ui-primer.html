<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>How A2UI Works - Message Flow</title>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&family=Google+Sans+Text:wght@400;500&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-dark: #131314;
      --bg-card: #1e1f20;
      --bg-code: #0d1117;
      --border: #3c4043;
      --text-primary: #e3e3e3;
      --text-secondary: #9aa0a6;
      --accent-blue: #8ab4f8;
      --accent-green: #81c995;
      --accent-yellow: #fdd663;
      --accent-purple: #c58af9;
      --accent-orange: #fcad70;
    }

    body {
      font-family: "Google Sans Text", sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #4285f4 0%, #8ab4f8 50%, #c58af9 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo .material-symbols-outlined {
      color: white;
      font-size: 24px;
    }

    h1 {
      font-size: 24px;
      font-weight: 500;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .back-link {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--accent-blue);
      text-decoration: none;
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      transition: background 0.2s;
    }

    .back-link:hover {
      background: rgba(138, 180, 248, 0.1);
    }

    .intro {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
      border: 1px solid var(--border);
    }

    .intro h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: var(--accent-blue);
    }

    .intro p {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .flow-diagram {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 24px 0;
      flex-wrap: wrap;
    }

    .flow-box {
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      text-align: center;
    }

    .flow-box.client { background: rgba(138, 180, 248, 0.2); color: var(--accent-blue); }
    .flow-box.server { background: rgba(129, 201, 149, 0.2); color: var(--accent-green); }
    .flow-box.agent { background: rgba(197, 138, 249, 0.2); color: var(--accent-purple); }

    .flow-arrow {
      color: var(--text-secondary);
      font-size: 20px;
    }

    .message-sequence {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .message-card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .sequence-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .sequence-num.client-to-server { background: var(--accent-blue); color: #1e1f20; }
    .sequence-num.server-to-agent { background: var(--accent-green); color: #1e1f20; }
    .sequence-num.agent-to-server { background: var(--accent-purple); color: #1e1f20; }
    .sequence-num.server-to-client { background: var(--accent-orange); color: #1e1f20; }

    .message-direction {
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 4px 10px;
      border-radius: 12px;
    }

    .message-direction.client-to-server { background: rgba(138, 180, 248, 0.2); color: var(--accent-blue); }
    .message-direction.server-to-agent { background: rgba(129, 201, 149, 0.2); color: var(--accent-green); }
    .message-direction.agent-to-server { background: rgba(197, 138, 249, 0.2); color: var(--accent-purple); }
    .message-direction.server-to-client { background: rgba(252, 173, 112, 0.2); color: var(--accent-orange); }

    .message-endpoint {
      flex: 1;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .message-body {
      padding: 20px;
    }

    .message-description {
      font-size: 15px;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .message-description strong {
      color: var(--accent-yellow);
    }

    .json-container {
      background: var(--bg-code);
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .json-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .json-content {
      padding: 16px;
      max-height: 400px;
      overflow-y: auto;
      font-family: "Roboto Mono", monospace;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .json-content::-webkit-scrollbar {
      width: 8px;
    }

    .json-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .json-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    /* JSON Syntax Highlighting */
    .json-key { color: #79c0ff; }
    .json-string { color: #a5d6ff; }
    .json-number { color: #ffa657; }
    .json-boolean { color: #ff7b72; }
    .json-null { color: #ff7b72; }

    .callout {
      background: rgba(253, 214, 99, 0.1);
      border-left: 3px solid var(--accent-yellow);
      padding: 12px 16px;
      margin-top: 16px;
      border-radius: 0 8px 8px 0;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .callout strong {
      color: var(--accent-yellow);
    }

    .a2ui-highlight {
      background: rgba(197, 138, 249, 0.15);
      border: 1px solid rgba(197, 138, 249, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .a2ui-highlight h4 {
      color: var(--accent-purple);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .a2ui-highlight p {
      font-size: 13px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="logo">
        <span class="material-symbols-outlined">auto_awesome</span>
      </div>
      <div>
        <h1>How A2UI Works</h1>
        <div class="subtitle">Message Flow Between Client, Server, and Remote Agent</div>
      </div>
    </div>
    <a href="/" class="back-link">
      <span class="material-symbols-outlined">arrow_back</span>
      Back to Demo
    </a>
  </header>

  <div class="intro">
    <h2>The A2UI Message Flow</h2>
    <p>This page shows a <strong>representative message sequence</strong> from when a user asks for flashcards about ATP.</p>
    <p>A2UI enables agents to generate rich UI components as <strong>declarative JSON data</strong>, not executable code. The client application renders these using its own native components.</p>

    <div class="flow-diagram">
      <div class="flow-box client">Browser Client</div>
      <span class="flow-arrow">→</span>
      <div class="flow-box server">Local API Server<br><small style="opacity:0.8">(api-server.ts)</small></div>
      <span class="flow-arrow">→</span>
      <div class="flow-box agent">Remote Agent<br><small style="opacity:0.8">(Vertex AI Agent Engine)</small></div>
      <span class="flow-arrow">→</span>
      <div class="flow-box server">Local API Server</div>
      <span class="flow-arrow">→</span>
      <div class="flow-box client">Browser Renders</div>
    </div>
  </div>

  <div class="message-sequence">

    <!-- Message 1: Client → Server (Intent Detection) -->
    <div class="message-card">
      <div class="message-header">
        <div class="sequence-num client-to-server">1</div>
        <span class="message-direction client-to-server">Client → Server</span>
        <span class="message-endpoint">/api/chat (Intent Detection)</span>
      </div>
      <div class="message-body">
        <div class="message-description">
          User types <strong>"Create flashcards for bond energy misconceptions"</strong>. The orchestrator first sends this to Gemini to detect the user's intent.
        </div>
        <div class="json-container">
          <div class="json-header">
            <span>Request Payload</span>
            <span>JSON</span>
          </div>
          <div class="json-content" id="json1"></div>
        </div>
      </div>
    </div>

    <!-- Message 2: Server → Client (Intent Response) -->
    <div class="message-card">
      <div class="message-header">
        <div class="sequence-num server-to-client">2</div>
        <span class="message-direction server-to-client">Server → Client</span>
        <span class="message-endpoint">/api/chat (Intent Classification)</span>
      </div>
      <div class="message-body">
        <div class="message-description">
          Gemini classifies the intent as <strong>"flashcards"</strong>. This tells the orchestrator to fetch A2UI content from the specialized agent.
        </div>
        <div class="json-container">
          <div class="json-header">
            <span>Response</span>
            <span>JSON</span>
          </div>
          <div class="json-content" id="json2"></div>
        </div>
      </div>
    </div>

    <!-- Message 3: Client → Server (A2UI Request) -->
    <div class="message-card">
      <div class="message-header">
        <div class="sequence-num client-to-server">3</div>
        <span class="message-direction client-to-server">Client → Server</span>
        <span class="message-endpoint">/a2ui-agent/a2a/query</span>
      </div>
      <div class="message-body">
        <div class="message-description">
          The browser requests A2UI content generation. It specifies <strong>format: flashcards</strong> and includes context about what the user asked for.
        </div>
        <div class="json-container">
          <div class="json-header">
            <span>Request Payload</span>
            <span>JSON</span>
          </div>
          <div class="json-content" id="json3"></div>
        </div>
      </div>
    </div>

    <!-- Message 4: Server → Agent Engine -->
    <div class="message-card">
      <div class="message-header">
        <div class="sequence-num server-to-agent">4</div>
        <span class="message-direction server-to-agent">Server → Remote Agent</span>
        <span class="message-endpoint">Deployed to Vertex AI Agent Engine</span>
      </div>
      <div class="message-body">
        <div class="message-description">
          The server forwards the request to a <strong>remote A2UI-generating agent deployed to Vertex AI Agent Engine</strong>. This agent is a separate service that specializes in generating A2UI content.
        </div>
        <div class="json-container">
          <div class="json-header">
            <span>Request to Remote Agent (via Agent Engine API)</span>
            <span>JSON</span>
          </div>
          <div class="json-content" id="json4"></div>
        </div>
        <div class="callout">
          <strong>Key Point:</strong> This is the A2A (Agent-to-Agent) pattern described in the blog. The orchestrator delegates UI generation to a specialized remote agent deployed on Vertex AI Agent Engine - demonstrating cross-boundary agent collaboration.
        </div>
      </div>
    </div>

    <!-- Message 5: Agent Engine → Server (A2UI Response) -->
    <div class="message-card">
      <div class="message-header">
        <div class="sequence-num agent-to-server">5</div>
        <span class="message-direction agent-to-server">Remote Agent → Server</span>
        <span class="message-endpoint">Response from Vertex AI Agent Engine</span>
      </div>
      <div class="message-body">
        <div class="message-description">
          The remote agent (deployed on Agent Engine) returns <strong>A2UI JSON</strong> - a declarative description of UI components. This is the core of what A2UI provides.
        </div>
        <div class="json-container">
          <div class="json-header">
            <span>A2UI Messages (Parsed)</span>
            <span>JSON • Scroll to see full payload</span>
          </div>
          <div class="json-content" id="json5"></div>
        </div>
        <div class="a2ui-highlight">
          <h4>Understanding the A2UI Structure</h4>
          <p><strong>beginRendering</strong> - Declares the surface and root component ID<br>
          <strong>surfaceUpdate</strong> - Contains the flat list of components with ID references<br>
          <strong>Components</strong> - Text, Column, Row, Flashcard - these are catalog components the client knows how to render</p>
        </div>
      </div>
    </div>

    <!-- Message 6: Server → Client -->
    <div class="message-card">
      <div class="message-header">
        <div class="sequence-num server-to-client">6</div>
        <span class="message-direction server-to-client">Server → Client</span>
        <span class="message-endpoint">/a2ui-agent/a2a/query</span>
      </div>
      <div class="message-body">
        <div class="message-description">
          The server sends the A2UI payload to the browser. The <strong>@a2ui/web-lib</strong> renderer processes this JSON and creates native web components.
        </div>
        <div class="json-container">
          <div class="json-header">
            <span>Final Response to Browser</span>
            <span>JSON</span>
          </div>
          <div class="json-content" id="json6"></div>
        </div>
        <div class="callout">
          <strong>Result:</strong> The browser's A2UI renderer creates &lt;a2ui-surface&gt;, which contains &lt;a2ui-flashcard&gt; components styled to match the host application's theme.
        </div>
      </div>
    </div>

  </div>

  <script>
    // Representative example data from a real demo session
    const exampleMessages = {
      msg1: {
        userMessage: "Create flashcards for bond energy misconceptions",
        intentGuidance: "You are an intent classifier. Analyze the user's message...",
        conversationLength: 0
      },
      msg2: {
        text: "flashcards"
      },
      msg3: {
        message: "flashcards:Create flashcards for bond energy misconceptions",
        session_id: "session_1734567890123_abc123def",
        extensions: ["https://a2ui.org/a2a-extension/a2ui/v0.8"]
      },
      msg4: {
        class_method: "stream_query",
        input: {
          user_id: "demo-user",
          message: "Generate flashcards for: Create flashcards for bond energy misconceptions"
        }
      },
      msg5: [
        {
          beginRendering: {
            surfaceId: "learningContent",
            root: "mainColumn"
          }
        },
        {
          surfaceUpdate: {
            surfaceId: "learningContent",
            components: [
              {
                id: "mainColumn",
                component: {
                  Column: {
                    children: { explicitList: ["headerText", "flashcardRow"] },
                    distribution: "start",
                    alignment: "stretch"
                  }
                }
              },
              {
                id: "headerText",
                component: {
                  Text: {
                    text: { literalString: "Study Flashcards: ATP & Bond Energy" },
                    usageHint: "h3"
                  }
                }
              },
              {
                id: "flashcardRow",
                component: {
                  Row: {
                    children: { explicitList: ["card1", "card2", "card3"] },
                    distribution: "start",
                    alignment: "stretch"
                  }
                }
              },
              {
                id: "card1",
                component: {
                  Flashcard: {
                    front: { literalString: "Why does ATP hydrolysis release energy?" },
                    back: { literalString: "ATP hydrolysis releases energy because the products (ADP + Pi) are MORE STABLE than ATP. The phosphate groups in ATP repel each other due to negative charges. When the terminal phosphate is removed, this electrostatic strain is relieved, and the products achieve better resonance stabilization." },
                    category: { literalString: "Biochemistry" }
                  }
                }
              },
              {
                id: "card2",
                component: {
                  Flashcard: {
                    front: { literalString: "Does breaking a chemical bond release energy?" },
                    back: { literalString: "NO - this is a common MCAT trap! Breaking ANY bond REQUIRES energy input (it's endothermic). Energy is only released when NEW bonds FORM. In ATP hydrolysis, the energy released comes from forming more stable bonds in the products." },
                    category: { literalString: "Common Trap" }
                  }
                }
              },
              {
                id: "card3",
                component: {
                  Flashcard: {
                    front: { literalString: "What's wrong with saying 'ATP stores energy in its bonds'?" },
                    back: { literalString: "Bonds don't 'store' energy like batteries. Think of it like holding a plank position at the gym - you're not storing energy, you're in a high-energy unstable state. When you release to rest (ATP → ADP + Pi), you move to a more stable, lower-energy state." },
                    category: { literalString: "MCAT Concept" }
                  }
                }
              }
            ]
          }
        }
      ],
      msg6: {
        format: "flashcards",
        surfaceId: "learningContent",
        source: {
          url: "https://openstax.org/books/biology-ap-courses/pages/6-2-potential-kinetic-free-and-activation-energy",
          title: "OpenStax Biology for AP Courses",
          provider: "OpenStax"
        },
        a2uiMessageCount: 2,
        a2uiPayload: "[ ... see Message 5 for full A2UI content ... ]"
      }
    };

    // Simple JSON syntax highlighter
    function highlightJSON(obj) {
      const json = JSON.stringify(obj, null, 2);
      return json
        .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
        .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
        .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
        .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
        .replace(/: (null)/g, ': <span class="json-null">$1</span>');
    }

    // Populate JSON containers
    document.getElementById('json1').innerHTML = highlightJSON(exampleMessages.msg1);
    document.getElementById('json2').innerHTML = highlightJSON(exampleMessages.msg2);
    document.getElementById('json3').innerHTML = highlightJSON(exampleMessages.msg3);
    document.getElementById('json4').innerHTML = highlightJSON(exampleMessages.msg4);
    document.getElementById('json5').innerHTML = highlightJSON(exampleMessages.msg5);
    document.getElementById('json6').innerHTML = highlightJSON(exampleMessages.msg6);
  </script>
</body>
</html>
